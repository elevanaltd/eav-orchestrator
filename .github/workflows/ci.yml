# TESTGUARD_APPROVED: Maintains zero-tolerance CI integrity per consultation be92c7f5-0d20-47cf-b626-5f1e06c613be
# Critical-Engineer: consulted for CI/CD quality gate implementation
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, project-migration]

jobs:
  # P0 CRITICAL: Core quality gates implementation per critical-engineer blocking assessment
  test-and-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Node.js setup for quality gate execution
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      # Cache optimization for faster builds
      - name: Cache node modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          
      # Install dependencies - BLOCKING if fails
      - name: Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci
        
      # TRACED Protocol E-gate enforcement: Lint must pass
      - name: Lint Check (Zero Tolerance)
        run: npm run lint
        
      # TRACED Protocol E-gate enforcement: TypeScript must pass
      - name: Type Check
        run: npm run typecheck
        
      # TRACED Protocol E-gate enforcement: Tests must pass
      - name: Run Tests
        run: npm test
        env:
          # Test environment configuration
          NODE_ENV: test
          
      # Upload test artifacts on failure for debugging
      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: |
            coverage/
            test-results.xml
            *.log
      
      # Essential structural checks - MUST PASS
      - name: Validate Directory Structure
        run: |
          echo "Checking required files and directories..."
          test -d docs || (echo "❌ docs/ directory missing" && exit 1)
          test -f README.md || (echo "❌ README.md missing" && exit 1)
          test -f CLAUDE.md || (echo "❌ CLAUDE.md missing" && exit 1)
          echo "✅ Directory structure valid"
      
      # HestAI Documentation Standards Validation - MUST PASS
      # Based on hestai-doc-steward consultation
      - name: Validate HestAI Documentation Standards
        run: |
          echo "Running HestAI documentation standards validation..."
          # Make script executable
          chmod +x scripts/validate-docs.sh
          # Run validation with blocking checks only
          ./scripts/validate-docs.sh --blocking-only
          
      # Security scanning - MUST PASS
      - name: Check for Committed Secrets (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --debug --only-verified
          
      # For push events, scan the whole repository
      - name: Check for Committed Secrets (Push)
        if: github.event_name == 'push'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified
          
      # File size validation - MUST PASS
      - name: Validate No Large Files
        run: |
          echo "Checking for large files..."
          large_files=$(find . -type f -size +1M | grep -v "^./.git" | grep -v "node_modules" || true)
          if [ -n "$large_files" ]; then
            echo "❌ Large files detected (>1MB):"
            echo "$large_files"
            exit 1
          fi
          echo "✅ No large files detected"
        
      # Document required ADRs exist - WARNING ONLY during early phases
      - name: Check for ADRs
        run: |
          echo "Checking for Architectural Decision Records..."
          if [ -d "docs/adr" ]; then
            adr_count=$(find docs/adr -name "*.md" -type f | wc -l)
            echo "✅ Found $adr_count ADR(s)"
          else
            echo "⚠️  Warning: No ADR directory found (will be required after B0)"
            # Not failing during initial setup
          fi